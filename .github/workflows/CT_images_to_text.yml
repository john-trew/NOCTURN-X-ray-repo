name: CT Images to Text

on:
  workflow_run:
    workflows: ["Parse MorphoSource Data"]
    types: [completed]

jobs:
  ct_image_text_job:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          pip install requests beautifulsoup4 openai selenium pillow webdriver-manager

      - name: Fetch Latest Release
        id: fetch_release
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          echo "Fetching the latest release from this repo..."
          response=$(curl -sSL -H "Authorization: Bearer $GITHUB_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest)
          
          # Extract body
          body=$(echo "$response" | python3 -c $'import sys, json\ntry:\n    data = json.load(sys.stdin)\n    print(data.get("body", ""))\nexcept:\n    print("")')
          
          # Extract tag name
          tag_name=$(echo "$response" | python3 -c $'import sys, json\ntry:\n    data = json.load(sys.stdin)\n    print(data.get("tag_name", ""))\nexcept:\n    print("")')
          
          # Extract URL from body
          url=$(echo "$body" | python3 -c $'import sys, re\ntry:\n    content = sys.stdin.read()\n    match = re.search(r"https://[^\s\)\\"\']+", content)\n    print(match.group(0) if match else "NO_URL_FOUND")\nexcept:\n    print("NO_URL_FOUND")')
          
          if [ -z "$tag_name" ]; then
            echo "Error: Could not extract tag_name from release"
            exit 1
          fi
          
          if [ "$url" != "NO_URL_FOUND" ]; then
            echo "morphosource_url=$url" >> "$GITHUB_OUTPUT"
          else
            echo "morphosource_url=" >> "$GITHUB_OUTPUT"
          fi
          
          echo "release_tag=$tag_name" >> "$GITHUB_OUTPUT"

      - name: Check if morphosource-updates
        id: check_morpho
        run: |
          TAG_NAME="${{ steps.fetch_release.outputs.release_tag }}"
          if [[ "$TAG_NAME" == morphosource-updates-* ]]; then
            echo "is_morphosource=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_morphosource=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate Timestamp
        id: gen_ts
        if: steps.check_morpho.outputs.is_morphosource == 'true'
        run: |
          TS=$(date +'%Y-%m-%d_%H-%M-%S')
          echo "timestamp=$TS" >> "$GITHUB_OUTPUT"

      - name: Process CT Images
        id: process_images
        if: steps.check_morpho.outputs.is_morphosource == 'true' && steps.fetch_release.outputs.morphosource_url != ''
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MORPHOSOURCE_URL: ${{ steps.fetch_release.outputs.morphosource_url }}
        run: |
          if [ -z "$MORPHOSOURCE_URL" ]; then
            echo "No valid MorphoSource URL found in release."
            exit 1
          fi
          
          mkdir -p screenshots
          python .github/scripts/ct_image_to_text.py "$MORPHOSOURCE_URL" screenshots > ct_image_output.txt
          
          echo "description<<EOF" >> "$GITHUB_OUTPUT"
          cat ct_image_output.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create Image Analysis Release
        if: steps.check_morpho.outputs.is_morphosource == 'true' && success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        with:
          tag_name: "ct_image_analysis-${{ steps.gen_ts.outputs.timestamp }}"
          release_name: "CT Image Analysis #${{ steps.gen_ts.outputs.timestamp }}"
          body: ${{ steps.process_images.outputs.description }}
          draft: false
          prerelease: false

      - name: Handle Errors
        if: failure()
        run: |
          echo "Workflow failed. Please check:"
          echo "1. Release tag format"
          echo "2. Valid MorphoSource URL in release body"
          echo "3. OpenAI API key configuration"
          echo "4. Python dependencies installation"
          echo "5. Screenshot capture process"
          exit 1

      - name: No new morphosource release
        if: steps.check_morpho.outputs.is_morphosource == 'false'
        run: echo "No 'morphosource-updates-*' release found. Skipping CT image analysis."
